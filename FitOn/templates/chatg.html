<html>

<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Group Chat</title>
    <link rel="stylesheet" type="text/css" href="../static/css/chat.css">

    <style>
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .dialogoverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            width: 300px;
            z-index: 1001;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }

        .open-btn {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .open-btn:hover {
            background-color: #45a049;
        }

        .checkbox-list {
            list-style: none;
            padding: 0;
        }

        .checkbox-item {
            margin: 10px 0;
        }

        .checkbox-item input {
            margin-right: 10px;
        }

        .submit-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        .submit-btn:hover {
            background-color: #45a049;
        }

        .result {
            margin-top: 20px;
            font-size: 16px;
            color: #333;
        }

        .dialog .buttons button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .dialog .buttons .confirm {
            background-color: #4CAF50;
            color: white;
        }

        .dialog .buttons .cancel {
            background-color: #f44336;
            color: white;
        }

        .dialog .buttons button:hover {
            opacity: 0.8;
        }
    </style>

</head>

<body>
    <div class="container">
        <div class="leftSide">
            <!--header-->

            <!--search-->
            <button style="width: 100%;height: 60px" id="private">
                Private Chat
            </button>
            <button style="width: 100%;height: 60px" onclick="showCreateGroupPopup()">
                Create a Group
            </button>
            <button style="width: 100%;height: 60px" onclick="requestCheckInvitations()">
                Check Pending Invitations
            </button>
            <!--ChatList-->

            {% for i in data %}
            <div class="chatlist" data-room-name="{{ i.name }}"">
                <div class=" block">
                <div class="details">
                    <div class="listHead">
                        <h4>{{ i.name }}</h4>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>


    <div class="overlay" id="overlay">
        <div class="popup">
            <button class="close-btn" onclick="closeCreateGroupPopup()">×</button>
            <h2>Select Members</h2>

            <label for="roomName">Room Name:</label>
            <input type="text" id="roomName" placeholder="Enter a unique room name" required>

            <ul class="checkbox-list">
                {% for i in allUser %}
                <li class="checkbox-item">
                    <label>
                        <input type="checkbox" class="fruit-checkbox" value="{{ i.user_id }}"> {{ i.username }}
                    </label>
                </li>
                {% endfor %}
            </ul>

            <button class="submit-btn" onclick="submitCreateGroup()">Submit</button>
        </div>
    </div>

    <div class="overlay" id="overlayA">
        <div class="popup">
            <button class="close-btn" onclick="closeInvitePopup()">×</button>
            <h2>Select Members</h2>
            <ul class="checkbox-list">
                {% for i in allUser %}
                <li class="checkbox-item">
                    <label>
                        <input type="checkbox" class="fruit-checkbox" value="{{ i.user_id }}"> {{ i.username }}
                    </label>
                </li>
                {% endfor %}
            </ul>
            <button class="submit-btn" onclick="submitInviteMembers()">Submit</button>
        </div>
    </div>

    <div class="dialogoverlay" id="dialog">
        <div class="popup">
            <div class="message">You are Invited to a Group</div>
            <div class="buttons">
                <button class="confirm" onclick="handleConfirmJoin()">Join</button>
                <button class="cancel" onclick="handleCancelJoin()">Cancel</button>
            </div>
        </div>
    </div>


    <div id="rightBar" class="rightSide" style="visibility: hidden">
        <div class="header">
            <button id="leave" style="width: 120px">
                Leave
            </button>
            <button id="invent" style="width: 120px" onclick="showInvitePopup()">
                Invite
            </button>
        </div>
        <!--chatbox-->

        <div class="chatBox" id="chatBox">
        </div>

        <!--chat input-->
        <div class="chatbox_input">
            <div>
                <input id="input_message" type="text">
                <button id="submit" style="width: 40px">
                    Send
                </button>

            </div>

        </div>
    </div>

    </div>

    </div>


    <script>

        function showInvitationDialog() {
            document.getElementById('dialog').style.display = 'block';
        }

        function closeInvitationDialog() {
            document.getElementById('dialog').style.display = 'none';
        }


        function handleConfirmJoin() {
            data = {
                "userId": '{{  mine.user_id }}',
                "room": window.inviteRoomName,
            }
            const url = `http://${window.location.host}/chat/group/join/`;
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(json => {
                    if (json.code === '200') {
                        closeInvitationDialog();
                        location.reload()
                    }
                })
                .catch(error => alert('Error' + error));
        }

        function handleCancelJoin() {
            closeInvitationDialog();
        }

        function showCreateGroupPopup() {
            document.getElementById('overlay').style.display = 'block';
        }

        function closeCreateGroupPopup() {
            document.getElementById('overlay').style.display = 'none';
        }

        function showInvitePopup() {
            document.getElementById('overlayA').style.display = 'block';
        }


        function closeInvitePopup() {
            document.getElementById('overlayA').style.display = 'none';
        }

        function submitCreateGroup() {
            const roomName = document.getElementById('roomName').value.trim();

            if (roomName === "") {
                alert("You have to type in a room name!");
                return;
            }


            const checkboxes = document.querySelectorAll('.fruit-checkbox');
            lis = []
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    lis.push(checkbox.value)
                }
            });

            const data = {
                "allUser": lis,
                "mineId": '{{ mine.user_id }}',
                "roomName": roomName
            }
            sendCreatePostRequest(data);
        }

        function sendCreatePostRequest(data) {
            const url = `http://${window.location.host}/chat/group/create/`;
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(json => {
                    if (json.code === '200') {
                        closeCreateGroupPopup();
                    }
                })
                .catch(error => alert('Error' + error));
        }

        function submitInviteMembers() {
            const checkboxes = document.querySelectorAll('.fruit-checkbox');
            lis = []
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    lis.push(checkbox.value)
                }
            });
            const data = {
                "allUser": lis,
                "roomName": window.current_room_name
            }
            sendInvitePostRequest(data)
        }


        function sendInvitePostRequest(data) {
            const url = `http://${window.location.host}/chat/group/invite/`;
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(json => {
                    if (json.code === '200') {
                        closeInvitePopup();
                    }
                })
                .catch(error => alert('Error' + error));
        }


        document.addEventListener('DOMContentLoaded', function () {
            const chatListItems = document.querySelectorAll('.chatlist');

            chatListItems.forEach(item => {
                item.addEventListener('click', function () {
                    startChat(this);
                });
            });

            var privateChat = document.getElementById('private')
            var leave = document.getElementById('leave')
            privateChat.addEventListener('click', function () {
                window.location.href = "/chat";
            })

            leave.addEventListener('click', function () {
                data = {
                    "userId": '{{  mine.user_id }}',
                    "room": window.current_room_name,
                }
                const url = `http://${window.location.host}/chat/group/leave/`;
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(json => {
                        if (json.code === '200') {
                            location.reload()
                        }
                    })
                    .catch(error => alert('Error' + error));
            })
        });

        let submitListener = null;

        function startChat(chatElement) {
            element = document.getElementById("rightBar")
            element.style.visibility = 'visible'

            const chatBox = document.getElementById("chatBox");
            if (chatBox) {
                chatBox.innerHTML = '';
            }

            if (window.chatSocket != null) {
                window.chatSocket.close(1000, 'Closing connection');
                window.chatSocket.onclose = null;
                window.chatSocket = null;
            }


            const blockListItems = document.querySelectorAll('.block');
            blockListItems.forEach(item => {
                item.classList.remove("active")
            })

            block = chatElement.querySelector('.block');
            block.classList.add("active")

            window.current_room_name = chatElement.getAttribute('data-room-name');

            const roomId = window.current_room_name;
            fetch(`/chat/history/${roomId}/`)
                .then(response => response.json())
                .then(data => {
                    data.messages.forEach(message => {
                        const messageDiv = document.createElement('div');
                        if (message.sender === '{{ mine.user_id }}') {
                            messageDiv.classList.add('message', 'my_message');
                        } else {
                            messageDiv.classList.add('message', 'frnd_message');
                        }
                        messageDiv.innerHTML = `<p><small>${message.sender_name}</small><br>${message.message}<br></p>`;
                        chatBox.appendChild(messageDiv);
                    });
                })
                .catch(error => {
                    console.error('Error fetching chat history:', error);
                });
            window.chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + current_room_name + '/');

            window.chatSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                console.log(data)
                const message = data;
                const messageDiv = document.createElement('div');
                if (message.sender === '{{ mine.user_id }}') {
                    messageDiv.classList.add('message', 'my_message');
                } else {
                    messageDiv.classList.add('message', 'frnd_message');
                }
                messageDiv.innerHTML = `<p><small>${message.sender_name}</small><br>${message.message}<br></p>`;
                chatBox.appendChild(messageDiv);
            };

            if (submitListener) {
                document.getElementById('submit').removeEventListener('click', submitListener);
            }

            submitListener = function () {
                submitMessage(this, window.chatSocket);
            };
            document.getElementById('submit').addEventListener('click', submitListener);


        }

        function submitMessage(element, chatSocket) {
            var inputValue = document.getElementById('input_message').value;
            chatSocket.send(JSON.stringify({
                'message': inputValue,
                'sender': '{{ mine.user_id }}'
            }));

        }

        function requestCheckInvitations() {
            const url = `http://${window.location.host}/chat/group/check/`;
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
            })
                .then(response => response.json())
                .then(response => {
                    response.data.forEach(
                        (item) => {
                            window.inviteRoomName = item.name
                            showInvitationDialog()
                        }
                    )

                })
                .catch(error => alert('Error' + error));
        }

    </script>


</body>

</html>