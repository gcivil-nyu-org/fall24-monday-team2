<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Group Chat</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <!-- <link rel="stylesheet" href="{% static 'css/chat.css' %}"> -->
    <script src="{% static 'js/navbar.js' %}" defer></script>
    <style>
        /* Override specific navbar styles */
        .navbar {
            padding: 15px 30px !important; /* Match global padding */
        }
        .navbar-logo {
            font-size: 28px !important; /* Match global logo font size */
        }
        .navbar-links {
            gap: 40px !important; /* Match global link spacing */
        }
        .navbar-links a {
            padding: 15px 20px !important; /* Match global link padding */
            font-size: 18px !important; /* Match global font size */
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="{% url 'homepage' %}" class="navbar-logo">FitOn</a>
            <div class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <ul class="navbar-links">
                {% if request.session.username %}
                    {% if is_admin %}
                        <li><a href="{% url 'fitness_trainers_list' %}">Fitness Trainers</a></li>
                        <li><a href="{% url 'fitness_trainer_applications_list' %}">Review Applications</a></li>
                        <li><a href="{% url 'punishments' %}">Manage Punishments</a></li>
                    {% endif %}
                    <li><a href="{% url 'forum' %}">Forums</a></li>
                    <li><a href="{% url 'homepage' %}">Workouts</a></li>
                    <li><a href="{% url 'get_metric_data' %}">Metrics</a></li>
                    <li><a href="{% url 'profile' %}">Profile</a></li>
                    <li><a href="{% url 'chat' %}">Chat</a></li>
                    <li><a href="{% url 'logout' %}">Logout</a></li>
                {% else %}
                    <li><a href="{% url 'login' %}">Login</a></li>
                    <li><a href="{% url 'signup' %}">Sign Up</a></li>
                {% endif %}
            </ul>
        </div>
    </nav>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scrolling */
            font-family: 'Open Sans', sans-serif;
        }
        .navbar, .navbar-container, .navbar a {
            font-family: 'Times New Roman', sans-serif !important; /* Reset to default system font */
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .dialogoverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            width: 80%; /* Adjusted for larger screen width */
            max-width: 800px; /* Maximum width */
            height: auto; /* Automatically adjusts to content */
            min-height: 400px; /* Ensures sufficient vertical space */
            max-height: 90%; /* Prevents it from overflowing the viewport */
            overflow-y: auto; /* Adds scrolling if content exceeds max-height */
            z-index: 1001;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }

        .open-btn {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .open-btn:hover {
            background-color: #45a049;
        }

        .checkbox-list {
            list-style: none;
            padding: 0;
        }

        .checkbox-item {
            margin: 10px 0;
        }

        .checkbox-item input {
            margin-right: 10px;
        }

        .submit-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        .submit-btn:hover {
            background-color: #45a049;
        }

        .result {
            margin-top: 20px;
            font-size: 16px;
            color: #333;
        }

        .dialog .buttons button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .dialog .buttons .confirm {
            background-color: #4CAF50;
            color: white;
        }

        .dialog .buttons .cancel {
            background-color: #f44336;
            color: white;
        }

        .dialog .buttons button:hover {
            opacity: 0.8;
        }
        .container {
            display: flex;
            flex-direction: row;
            height: calc(100vh - 60px); /* Full height minus navbar */
            margin: 0 auto;
            overflow: hidden;
            max-width: 1200px;
            width: 95%; /* Use most of the viewport width */
        }
        .rightSide {
            flex: 1; /* Takes the remaining width */
            display: flex;
            flex-direction: column; /* Stack header, chatBox, and input vertically */
            background-color: #ffffff;
            border-left: 1px solid #ccc;
            box-sizing: border-box;
            height: 100%; /* Full height to ensure proper flexbox behavior */
            overflow: hidden; /* Prevents overflow of child elements */
        }
        .leftSide {
            flex: 0 0 30%; /* Sidebar takes 18% of the width */
            background-color: #f5f5f5;
            overflow-y: auto;
            height: 100%;
        }
        .header {
            background-color: #f5f5f5; /* Match grey container background */
            padding: 10px; /* Adjust padding to suit design */
            border-bottom: 1px solid #ccc; /* Optional: separate header visually */
        }
        .chatBox {
            display: flex;
            flex-direction: column; /* Stack messages vertically */
            gap: 10px; /* Add spacing between messages */
            padding: 20px;
            padding-bottom: 220px;
            overflow-y: auto;
            background-color: #f9f9f9;
            box-sizing: border-box;
            height: calc(100vh - 140px);
            scroll-behavior: smooth;
        }
        .chatBox:empty::before {
            width: 100%;
            display: block;
            margin-top: 20px; /* Adjust vertical spacing as needed */
        }
        .chatbox_input {
            flex-shrink: 0; /* Prevent shrinking */
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background-color: #f5f5f5;
            border-top: 1px solid #ccc;
            box-sizing: border-box;
            position: sticky; /* Sticks at the bottom */
            bottom: 0;
            z-index: 10;
            height: 100px;
        }
        #char_count {
            position: absolute;
            top: 5px; /* Near the top-right corner */
            right: 10px;
            font-size: 12px;
            color: #666;
        }
        .chatbox_input input {
            flex-grow: 1; /* Allow the input field to take all available space */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .chatbox_input button {
            padding: 10px 20px;
            height: 40px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        .chatbox_input button:hover {
            background-color: #45a049;
        }
        .message {
            display: inline-block; /* Ensure each message occupies its own line */
            padding: 5px 10px; /* Add padding inside the bubble */
            max-width: 70%; /* Limit bubble width for readability */
            border-radius: 8px; /* Rounded corners for bubbles */
            word-wrap: break-word;
            overflow-wrap: break-word;
            margin: 2px 0;
            line-height: 1.2;
        }

        .my_message {
            align-self: flex-end; /* Align messages from the sender to the right */
            background-color: #dcf8c6; /* Light green for sender */
            text-align: left;
        }

        .frnd_message {
            align-self: flex-start; /* Align messages from friends to the left */
            background-color: #f5f5dc; /* Light yellow for friend */
            text-align: left;
        }
        .username {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
            display: block; /* Separate username from the message */
        }
        .timestamp-bubble {
            position: absolute;
            top: -30px; /* Place it higher above the message */
            left: 50%; /* Center it */
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            white-space: nowrap;
            pointer-events: none; /* Prevent interaction */
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        .search-results {
            list-style: none;
            padding: 0;
            margin: 10px 0;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: #f9f9f9;
        }

        .search-results li {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
        }

        .search-results li:hover {
            background-color: #e9e9e9;
        }

        .selected-users {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }

        .selected-users li {
            padding: 5px 10px;
            background-color: #d4fdd4;
            border-radius: 5px;
            margin: 5px 0;
            display: inline-block;
        }
        .default-message {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 18px;
            background-color: #f5f5f5; /* Optional for better contrast */
        }
        .chat-button {
            width: 100%;
            height: 60px;
            background-color: #007bff; 
            color: #ffffff; /* White font */
            border: 2px solid #0056b3;
            border-radius: 0.5px;
            font-size: 16px; /* Adjust font size if needed */
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .chat-button:hover {
            background-color: #0056b3; /* Slightly darker blue on hover */
        }
        .group-chat-list {
            height: 100%; /* Take up the full height of the parent container */
            overflow-y: auto; /* Enable scrolling for the entire list */
            padding: 5px; /* Add consistent padding */
            scrollbar-width: thin; /* For modern browsers, slim scrollbar */
            scrollbar-color: #ccc #f6f6f6; /* Thumb and track colors */
        }
        .group-chat-list .block {
            height: 50px; /* Fixed height for each block */
            display: flex;
            align-items: center;
            padding: 10px; /* Maintain consistent padding */
            border-bottom: 1px solid rgba(0, 0, 0, 0.06); /* Separator between items */
            background-color: #f6f6f6; /* Background color */
            transition: background-color 0.3s ease; /* Smooth hover effect */
            overflow: hidden;
        }
        .group-chat-list .block:hover {
            background: #e8e8e8; /* Slightly darker background on hover */
            cursor: pointer; /* Indicate clickable area */
        }

        .group-chat-list .block.active {
            background: #dcdcdc; /* Highlight active block */
        }

        .group-chat-list::-webkit-scrollbar {
            width: 8px; /* Adjust width of scrollbar */
        }
        .group-chat-list::-webkit-scrollbar-thumb {
            background: #ccc; /* Scrollbar color */
            border-radius: 10px; /* Rounded scrollbar for better aesthetics */
        }

        .group-chat-list::-webkit-scrollbar-thumb:hover {
            background: #aaa; /* Darker scrollbar color on hover */
        }

    </style>

</head>

<body>
    <div class="container">
        <div class="leftSide">
            <!--header-->

            <!--search-->
            <button class="chat-button" id="private">
                Private Chat
            </button>
            <button class="chat-button" onclick="showCreateGroupPopup()">
                Create Groupchat
            </button>

            <!--ChatList-->
            <div class="group-chat-list">
                {% for i in data %}
                <div class="chatlist" data-room-name="{{ i.name }}">
                    <div class=" block">
                        <div class="details">
                            <div class="listHead">
                                <h4>{{ i.name }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="rightSide" id="rightBar">
            <div id="defaultMessage" class="default-message">
                <p>Select a chat from the list or start a new one</p>
            </div>
            <div id="chatView" style="display: none; height: 100%; flex-direction: column;">
                <div class="header">
                    <h2 id="groupChatTitle">Chat</h2>
                    <button id="leave" style="width: 120px">Leave</button>
                    <button id="invent" style="width: 120px" onclick="showInvitePopup()">Invite</button>
                </div>
                <div class="chatBox" id="chatBox"></div>
                <div class="chatbox_input">
                    <span id="char_count" style="margin-left: 10px; font-size: 12px; color: #666;">Characters remaining: 500</span>
                    <input id="input_message" type="text" placeholder="Type your message here..." maxlength="500" oninput="updateCharacterCount()" />
                    <button id="submit" style="background-color: #4CAF50; color: white; border-radius: 5px;">Send</button>
                </div>
            </div>
        </div>

    </div>


    <div class="overlay" id="overlay">
        <div class="popup">
            <button class="close-btn" onclick="closeCreateGroupPopup()">×</button>
            <h2>New Groupchat</h2>

            <label for="roomName">Room Name:</label>
            <input type="text" id="roomName" placeholder="Enter a unique room name" required>
            <div style="margin-top: 20px;"></div>
            <label for="searchUser">Search Users:</label>
            <input
                type="text"
                id="searchUser"
                placeholder="Search for users..."
                oninput="searchUsers()"
            />
        
            <ul id="searchResults" class="search-results"></ul>

            <h4>Invite Users:</h4>
            <ul id="selectedUsers" class="selected-users"></ul>

            <button class="submit-btn" onclick="submitCreateGroup()">Submit</button>
        </div>
    </div>

    <div class="overlay" id="overlayA">
        <div class="popup">
            <button class="close-btn" onclick="closeInvitePopup()">×</button>
            <h2>Invite New Members</h2>
            <label for="searchUser">Search Users:</label>
            <input
                type="text"
                id="searchUser"
                placeholder="Search for users..."
                oninput="searchUsers()"
            />
            <ul id="searchResults" class="search-results"></ul>
        
            <h4>Current Users:</h4>
            <ul id="currentUsers" class="current-users"></ul>
            
            <h4>Invite New Users:</h4>
            <ul id="selectedUsers" class="selected-users"></ul>

            <button class="submit-btn" onclick="submitInviteMembers()">Submit</button>
        </div>
    </div>

    <div class="dialogoverlay" id="dialog">
        <div class="popup">
            <div class="message">You are Invited to a Group</div>
            <div class="buttons">
                <button class="confirm" onclick="handleConfirmJoin()">Join</button>
                <button class="cancel" onclick="handleCancelJoin()">Cancel</button>
            </div>
        </div>
    </div>

    </div>

    </div>


    <script>

        function showInvitationDialog() {
            document.getElementById('dialog').style.display = 'block';
        }

        function closeInvitationDialog() {
            document.getElementById('dialog').style.display = 'none';
        }


        function handleConfirmJoin() {
            data = {
                "userId": '{{  mine.user_id }}',
                "room": window.inviteRoomName,
            }
            const url = `http://${window.location.host}/chat/group/join/`;
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(json => {
                    if (json.code === '200') {
                        closeInvitationDialog();
                        location.reload()
                    }
                })
                .catch(error => alert('Error' + error));
        }

        function handleCancelJoin() {
            closeInvitationDialog();
        }

        function showCreateGroupPopup() {
            document.getElementById('overlay').style.display = 'block';
        }

        function closeCreateGroupPopup() {
            document.getElementById('overlay').style.display = 'none';
        }

        function showInvitePopup() {
            const overlay = document.getElementById('overlayA');
            const currentUsersList = document.getElementById('currentUsers');
            const selectedUsersList = document.getElementById('selectedUsers');

            overlay.style.display = 'block';
            currentUsersList.innerHTML = ''; // Clear the current list
            selectedUsersList.innerHTML = ''; // Clear any previously selected users

            fetch(`/chat/group/members/${window.current_room_name}/`) // API endpoint to fetch current members
                .then(response => response.json())
                .then(data => {
                    if (data.members && data.members.length > 0) {
                        data.members.forEach(user => {
                            const listItem = document.createElement('li');
                            listItem.textContent = user.username; // Display the username
                            currentUsersList.appendChild(listItem);
                        });
                    } else {
                        const noUsers = document.createElement('li');
                        noUsers.textContent = 'No current users in this group.';
                        currentUsersList.appendChild(noUsers);
                    }
                })
                .catch(error => console.error('Error fetching current users:', error));
        }


        function closeInvitePopup() {
            document.getElementById('overlayA').style.display = 'none';
        }

        function submitCreateGroup() {
            const roomName = document.getElementById("roomName").value.trim();
            const selectedUsers = [...document.getElementById("selectedUsers").children].map(
                (item) => item.dataset.userId
            );

            if (!roomName) {
                alert("Room name is required.");
                return;
            }

            if (selectedUsers.length === 0) {
                alert("Please select at least one user.");
                return;
            }

            const data = {
                roomName: roomName,
                allUser: selectedUsers,
            };

            // Send data to the server
            fetch(`/chat/group/create/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(data),
            })
                .then((response) => response.json())
                .then((response) => {
                    if (response.code === "200") {
                        alert("Group created successfully!");
                        // Add the new group to the chat list dynamically
                        addGroupToChatList(roomName);
                        closeCreateGroupPopup();
                    } else {
                        alert("Error creating group: " + response.message);
                    }
                })
                .catch((error) => console.error("Error creating group:", error));
        }

        function sendCreatePostRequest(data) {
            const url = `http://${window.location.host}/chat/group/create/`;
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(json => {
                    if (json.code === '200') {
                        closeCreateGroupPopup();
                    }
                })
                .catch(error => alert('Error' + error));
        }

        function submitInviteMembers() {
            // Get the selected users from the list
            const selectedUsers = [...document.querySelectorAll("#selectedUsers li")].map(
                (item) => item.dataset.userId
            );

            console.log("Selected Users for Adding:", selectedUsers); // Debug log

            if (selectedUsers.length === 0) {
                alert("No users selected to add.");
                return;
            }

            // Prepare the data for submission
            const data = {
                roomName: window.current_room_name, // Use the current room name
                allUser: selectedUsers, // Send selected user IDs
            };

            // Submit the users to the backend
            fetch(`/chat/group/add_users/`, { // Replace with the correct endpoint
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(data),
            })
                .then((response) => response.json())
                .then((json) => {
                    console.log("Server Response for Adding Users:", json); // Debug log
                    if (json.code === "200") {
                        alert("Users added successfully!");
                        closeInvitePopup();
                        // Optionally, reload current users in the group
                        showInvitePopup();
                    } else {
                        alert("Error adding users: " + json.message);
                    }
                })
                .catch((error) => console.error("Error adding users:", error));
        }




        function sendInvitePostRequest(data) {
            console.log("Sending Invite Data:", data); // Debug log
            fetch(`/chat/group/invite/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(data),
            })
                .then((response) => response.json())
                .then((json) => {
                    console.log("Server Response:", json); // Debug log
                    if (json.code === "200") {
                        closeInvitePopup();
                        alert("Users invited successfully!");
                    } else {
                        alert("Error inviting users: " + json.message);
                    }
                })
                .catch((error) => console.error("Error sending invite:", error));
        }


        document.addEventListener('DOMContentLoaded', function () {

            const defaultMessage = document.getElementById("defaultMessage");
            const chatView = document.getElementById("chatView");

            // Show the default grey box on page load
            defaultMessage.style.display = "flex";
            chatView.style.display = "none";

            // Add event listeners to the chat list items
            const chatListItems = document.querySelectorAll('.chatlist');
            chatListItems.forEach(item => {
                item.addEventListener('click', function () {
                    startChat(this);
                });
            });

            const chatBox = document.getElementById("chatBox");

            // Add hover listeners to display timestamp
            chatBox.addEventListener("mouseover", function (e) {
                const messageDiv = e.target.closest(".message");
                if (!messageDiv) return;

                const timestamp = messageDiv.getAttribute("data-timestamp");
                if (!timestamp) return;

                // Avoid duplicate timestamp tooltips
                if (document.querySelector(".timestamp-bubble")) return;

                let parsedTimestamp;

                // Attempt to parse the timestamp
                if (!isNaN(timestamp)) {
                    // Handle UNIX timestamp (in seconds)
                    parsedTimestamp = new Date(Number(timestamp) * 1000);
                } else {
                    // Handle ISO 8601 or other date string formats
                    parsedTimestamp = new Date(timestamp);
                }

                if (isNaN(parsedTimestamp)) {
                    console.error("Invalid timestamp format:", timestamp);
                    return;
                }

                // Create and display tooltip
                const bubble = document.createElement("div");
                bubble.classList.add("timestamp-bubble");
                bubble.textContent = parsedTimestamp.toLocaleString(); // Display local time

                // Append bubble to the message
                messageDiv.appendChild(bubble);

            });

            chatBox.addEventListener("mouseout", function (e) {
                const messageDiv = e.target.closest(".message");
                if (!messageDiv) return;

                const bubble = messageDiv.querySelector(".timestamp-bubble");
                if (bubble) bubble.remove();
            });

            chatListItems.forEach(item => {
                item.addEventListener('click', function () {
                    startChat(this);
                });
            });

            var privateChat = document.getElementById('private')
            var leave = document.getElementById('leave')
            privateChat.addEventListener('click', function () {
                window.location.href = "/chat";
            })

            leave.addEventListener('click', function () {
                data = {
                    "userId": '{{  mine.user_id }}',
                    "room": window.current_room_name,
                }
                const url = `http://${window.location.host}/chat/group/leave/`;
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(json => {
                        if (json.code === '200') {
                            location.reload()
                        }
                    })
                    .catch(error => alert('Error' + error));
            })

            const inputMessage = document.getElementById('input_message');
            const submitButton = document.getElementById('submit');

            // Send message on button click
            submitButton.addEventListener('click', function () {
                submitMessage(this, window.chatSocket);
            });

            // Send message on "Enter" key press
            inputMessage.addEventListener('keydown', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Prevent default form submission behavior
                    submitMessage(this, window.chatSocket);
                }
            });

            // Scroll to the bottom when a new chat is loaded
            // Create a MutationObserver instance
            const observer = new MutationObserver(() => {
                scrollToLatestMessage();
            });
            observer.observe(chatBox, { childList: true });

        });

        let submitListener = null;

  
        function startChat(chatElement) {
            const defaultMessage = document.getElementById("defaultMessage");
            const chatView = document.getElementById("chatView");
            const chatHeader = document.getElementById("groupChatTitle");
            const chatBox = document.getElementById("chatBox");
            
            // Reset WebSocket on page load
            if (window.chatSocket != null) {
                window.chatSocket.close(1000, 'Closing connection on page load');
                window.chatSocket = null;
            }

            // Hide the default message and show the chat interface
            defaultMessage.style.display = "none"; // Hide default message
            chatView.style.display = "block"; // Show chat view

            // Clear the chat box
            chatBox.innerHTML = "";

            // Set the chat header to the selected chat's name
            const roomName = chatElement.getAttribute('data-room-name');
            chatHeader.textContent = roomName;

            // Highlight the active chat in the list
            const blockListItems = document.querySelectorAll('.block');
            blockListItems.forEach(item => {
                item.classList.remove("active");
            });

            const block = chatElement.querySelector('.block');
            block.classList.add("active");

            // Close any previous WebSocket connections
            if (window.chatSocket != null) {
                window.chatSocket.close(1000, 'Closing connection');
                window.chatSocket.onclose = null;
                window.chatSocket = null;
            }

            // Initialize WebSocket for the selected chat
            window.current_room_name = chatElement.getAttribute('data-room-name');

            //window.chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + window.current_room_name + '/');
            window.chatSocket = new WebSocket(
                (window.location.protocol === "https:" ? "wss://" : "ws://") +
                window.location.host +
                "/ws/chat/" +
                window.current_room_name +
                "/"
            );

            // Load chat history for the selected room
            fetch(`/chat/history/${window.current_room_name}/`)
                .then(response => response.json())
                .then(data => {
                    chatBox.innerHTML = "";
                    data.messages.forEach(message => {
                        const messageDiv = document.createElement('div');
                        const currentUserId = '{{ mine.user_id }}';
                        if (message.sender === currentUserId) {
                            messageDiv.classList.add('message', 'my_message');
                        } else {
                            messageDiv.classList.add('message', 'frnd_message');
                        }

                        messageDiv.innerHTML = `
                            <span class="username"><strong>${message.sender_name}</strong></span>
                            <p>${message.message}</p>`;
                        chatBox.appendChild(messageDiv);
                    });

                    // Scroll to the latest message
                    chatBox.scrollTop = chatBox.scrollHeight;
                })
                .catch(error => {
                    console.error('Error fetching chat history:', error);
                });

            window.chatSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                const chatBox = document.getElementById('chatBox');
                const messageDiv = document.createElement('div');

                const currentUserId = '{{ mine.user_id }}';
                console.log("Sender:", data.sender, "Current User:", currentUserId);

                if (data.sender === currentUserId) {
                    messageDiv.classList.add('message', 'my_message');
                } else {
                    messageDiv.classList.add('message', 'frnd_message');
                }

                messageDiv.innerHTML = `
                    <span class="username"><strong>${data.sender_name}</strong></span>
                    <p>${data.message}</p>`;

                chatBox.appendChild(messageDiv);

                // Scroll to the latest message
                scrollToLatestMessage();
            };
        }

        function submitMessage(element, chatSocket) {
            const inputValue = document.getElementById('input_message').value;

            if (inputValue.trim() === '') {
                alert('Message cannot be empty.');
                return;
            }

            chatSocket.send(JSON.stringify({
                'message': inputValue,
                'sender': '{{ mine.user_id }}'
            }));

            document.getElementById('input_message').value = ''; // Clear input field
            updateCharacterCount(); // Reset character count
        }

        function requestCheckInvitations() {
            const url = `http://${window.location.host}/chat/group/check/`;
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
            })
                .then(response => response.json())
                .then(response => {
                    response.data.forEach(
                        (item) => {
                            window.inviteRoomName = item.name
                            showInvitationDialog()
                        }
                    )

                })
                .catch(error => alert('Error' + error));
        }

        function updateCharacterCount() {
            const inputElement = document.getElementById('input_message');
            const charCountElement = document.getElementById('char_count');
            const maxLength = inputElement.getAttribute('maxlength');
            const remaining = maxLength - inputElement.value.length;

            charCountElement.textContent = `Characters remaining: ${remaining}`;
        }
        function searchUsers() {
            const query = document.getElementById("searchUser").value.trim().toLowerCase();
            const searchResults = document.getElementById("searchResults");
            searchResults.innerHTML = ""; // Clear previous results

            if (query === "") {
                return; // Exit if query is empty
            }

            // Fetch matching users from the server
            fetch(`/chat/search_users/?query=${query}`)
                .then((response) => {
                    console.log(response); // Log the raw response
                    return response.json();
                })
                .then((users) => {
                    console.log(users); // Log the parsed users
                    users.forEach((user) => {
                        const listItem = document.createElement("li");
                        listItem.textContent = user.username;
                        listItem.onclick = () => {
                            console.log("Clicked on user:", user); // Debug log
                            addUser(user);
                        };
                        searchResults.appendChild(listItem);
                    });
                })
                .catch((error) => console.error("Error fetching users:", error));
        }

        function addUser(user) {
            console.log("Adding user:", user); // Debug log
            const selectedUsers = document.getElementById("selectedUsers");
            const searchInput = document.getElementById("searchUser");
            const searchResults = document.getElementById("searchResults");

            // Check if the user is already added
            if ([...selectedUsers.children].some((item) => item.dataset.userId === user.user_id)) {
                console.log("User already added.");
                return;
            }

            // Add the user to the list
            const listItem = document.createElement("li");
            listItem.textContent = user.username;
            listItem.dataset.userId = user.user_id;

            // Optional: Add a remove button
            const removeButton = document.createElement("button");
            removeButton.textContent = "Remove";
            removeButton.style.marginLeft = "10px";
            removeButton.onclick = () => {
                console.log("Removing user:", user.username); // Debug log
                selectedUsers.removeChild(listItem);
            };

            listItem.appendChild(removeButton);
            selectedUsers.appendChild(listItem);

            // Clear the search input and results
            searchInput.value = ""; // Clear search input
            searchResults.innerHTML = ""; // Clear search results

            console.log("User added successfully.");
        }

        function addGroupToChatList(roomName) {
            const chatListContainer = document.querySelector(".leftSide");

            // Create the new group chat element
            const chatDiv = document.createElement("div");
            chatDiv.classList.add("chatlist");
            chatDiv.dataset.roomName = roomName;

            const blockDiv = document.createElement("div");
            blockDiv.classList.add("block");

            const detailsDiv = document.createElement("div");
            detailsDiv.classList.add("details");

            const listHeadDiv = document.createElement("div");
            listHeadDiv.classList.add("listHead");

            const roomNameHeading = document.createElement("h4");
            roomNameHeading.textContent = roomName;

            listHeadDiv.appendChild(roomNameHeading);
            detailsDiv.appendChild(listHeadDiv);
            blockDiv.appendChild(detailsDiv);
            chatDiv.appendChild(blockDiv);

            // Append the new group chat to the chat list
            chatListContainer.appendChild(chatDiv);

            // Add a click listener to open the chat dynamically
            chatDiv.addEventListener("click", function () {
                startChat(chatDiv);
            });
        }

        function scrollToLatestMessage() {
            const chatBox = document.getElementById('chatBox');
            chatBox.scrollTop = chatBox.scrollHeight;
            console.log("Scrolling to latest message:", chatBox.scrollTop);
        }

    </script>


</body>

</html>