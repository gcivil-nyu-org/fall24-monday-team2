{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="thread-container" style="width: 60%; margin: 0 auto;">
    <div class="thread-header" style="border-bottom: 1px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 20px;">
        <h2>{{ thread.Title }}</h2>
        <div style="display: flex; align-items: center; color: #888; font-size: 14px;">
            <p>Posted by <strong>{{ thread.UserID }}</strong> on {{ thread.CreatedAt|date:"M d, Y H:i" }}</p>
        </div>
    </div>

    <div class="thread-content" style="font-size: 16px; line-height: 1.5; margin-bottom: 30px;">
        <p>{{ thread.Content }}</p>
    </div>

    <!-- Like and Report buttons at the bottom -->
    <div style="display: flex; align-items: center; border-top: 1px solid #e0e0e0; padding-top: 10px;">
        <!-- Like Button -->
        <button id="like-btn" data-thread-id="{{ thread.ThreadID }}" style="background-color: {% if liked %}darkgreen{% else %}green{% endif %}; color: white; border: none; padding: 5px 15px; cursor: pointer; margin-right: 10px;">
            ▲ {{ thread.Likes }} Like{% if thread.Likes != 1 %}s{% endif %}
        </button>

        <!-- Report Button (Placeholder) -->
        <button id="report-btn" style="background-color: red; color: white; border: none; padding: 5px 15px; cursor: pointer;">
            ⚑ Report
        </button>
    </div>

    <!-- Posts section -->
    <div class="thread-replies" style="margin-top: 30px;">
        <h3 style="margin-bottom: 10px;">Posts</h3>
        {% for post in posts %}
        <div class="post" id="post-{{ post.PostID }}" style="padding: 10px; margin-bottom: 20px; border: 1px solid #e0e0e0; border-radius: 5px; background-color: #f9f9f9;">
            <div style="display: flex; justify-content: space-between;">
                <p><strong>{{ post.UserID }}</strong> said: </p>
                <p style="color: #888; font-size: 12px;">{{ post.CreatedAt|date:"M d, Y H:i" }}</p>
            </div>
            <p>{{ post.Content }}</p>
    
            <!-- Like and Report Buttons for Other Users' Comments Only -->
            {% if post.UserID != request.session.username %}
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <!-- Like/Unlike Comment Button -->
                <button class="like-comment-btn" data-post-id="{{ post.PostID }}" style="background-color: {% if post.PostID in liked_comments %}darkgreen{% else %}green{% endif %}; color: white; border: none; padding: 5px 15px; cursor: pointer;">
                    ▲ {{ post.Likes|default:0 }} Like{% if post.Likes != 1 %}s{% endif %}
                </button>
    
                <!-- Report Comment Button -->
                <button class="report-comment-btn" data-post-id="{{ post.PostID }}" style="background-color: red; color: white; border: none; padding: 5px 15px; cursor: pointer;">
                    ⚑ Report
                </button>
                <!-- New Reply button -->
                <button class="reply-comment-btn" data-post-id="{{ post.PostID }}" style="margin-left: auto; background-color: blue; color: white; border: none; padding: 5px 10px; cursor: pointer;">
                    ↩️ Reply
                </button>
            </div>
            <!-- Reply box container (initially hidden) -->
            <div id="reply-box-{{ post.PostID }}" style="display: none; margin-top: 10px;">
                <!-- Add unique id for the textarea -->
                <textarea id="reply-content-{{ post.PostID }}" placeholder="Write your reply..." rows="3" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd;"></textarea>
                
                <div style="display: flex; justify-content: flex-end; margin-top: 5px;">
                    <!-- Add class and data-post-id for JavaScript -->
                    <button class="submit-reply-btn" data-post-id="{{ post.PostID }}" style="background-color: #007bff; color: white; border: none; padding: 5px 15px; cursor: pointer;">Comment</button>
                </div>
            </div>

            {% endif %}
    
            <!-- Delete Button for the User's Own Comments Only -->
            {% if post.UserID == request.session.username %}
            <button class="delete-post-btn" data-post-id="{{ post.PostID }}" data-thread-id="{{ thread.ThreadID }}" style="background-color: white; color: red; border: 1px solid red; padding: 5px 10px; cursor: pointer; margin-top: 10px;">
                Delete Post
            </button>
            {% endif %}
        </div>
        {% empty %}
        <p>No posts yet. Be the first to post!</p>
        {% endfor %}
    </div>    
    
    <!-- Post form -->
    <form id="post-form" method="post" style="display: flex; align-items: center; margin-top: 30px;">
        {% csrf_token %}
        <textarea name="content" id="post-content" rows="3" placeholder="Write your post" style="flex-grow: 1; padding: 10px; border-radius: 5px; border: 1px solid #ddd;"></textarea>
        <button type="submit" id="post-submit" style="margin-left: 10px; padding: 8px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Post</button>
    </form>
    
</div>

<!-- JavaScript to handle Like, Delete Post, Report buttons, and Reply Box toggling via AJAX -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const likeButton = document.getElementById('like-btn');
    const reportButton = document.getElementById('report-btn');
    const deletePostButtons = document.querySelectorAll('.delete-post-btn');
    const likeCommentButtons = document.querySelectorAll('.like-comment-btn');
    const reportCommentButtons = document.querySelectorAll('.report-comment-btn');
    const replyCommentButtons = document.querySelectorAll('.reply-comment-btn');
    const postForm = document.getElementById('post-form');
    const postSubmitButton = document.getElementById('post-submit');

    postForm.addEventListener('submit', function(event) {
        // Disable the submit button to prevent multiple clicks
        postSubmitButton.disabled = true;
        postSubmitButton.textContent = "Posting..."; // Optional: change button text

        // Enable the button again after form submission is complete
        setTimeout(() => {
            postSubmitButton.disabled = false;
            postSubmitButton.textContent = "Post"; // Restore original text
        }, 3000); // Adjust timeout duration based on response time if needed
    });

    // Toggle visibility of the reply box
    function toggleReplyBox(postId) {
        const replyBox = document.getElementById(`reply-box-${postId}`);
        if (replyBox.style.display === 'none' || replyBox.style.display === '') {
            replyBox.style.display = 'block';
        } else {
            replyBox.style.display = 'none';
        }
    }

    // Reply Button Click
    replyCommentButtons.forEach(button => {
        button.addEventListener('click', function() {
            const postId = this.dataset.postId;
            toggleReplyBox(postId);
        });
    });
    
    // Handle Submit Reply Button Click
    document.querySelectorAll('.submit-reply-btn').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            const postId = this.dataset.postId;
            const replyContent = document.getElementById(`reply-content-${postId}`).value;
            
             // Debugging log to ensure the button click is detected
            console.log("Reply submitted for post:", postId);  // First log
            
            if (replyContent.trim() === "") {
                alert("Reply content cannot be empty!");
                return;
            }

             // Another log to confirm AJAX call is about to happen
            console.log("Sending reply via AJAX for post:", postId);  // Second log

            fetch('/add_reply/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                    'x-requested-with': 'XMLHttpRequest'
                },
                body: JSON.stringify({ 'post_id': postId, 'content': replyContent })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const replyBox = document.getElementById(`reply-box-${postId}`);
                    replyBox.style.display = 'none';
                    document.getElementById(`reply-content-${postId}`).value = "";

                    // Append the new reply to the replies section
                    const repliesContainer = document.getElementById(`replies-${postId}`);
                    const newReply = document.createElement("div");
                    newReply.classList.add("reply");
                    newReply.style.border = "1px solid #ddd";
                    newReply.style.padding = "5px";
                    newReply.style.marginTop = "5px";
                    newReply.innerHTML = `<p><strong>${data.user}</strong> said: ${data.content}</p><p style="color: #888; font-size: 12px;">Just now</p>`;
                    repliesContainer.appendChild(newReply);
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });

    // Like thread post
    likeButton.addEventListener('click', function(event) {
        event.preventDefault();
        fetch(window.location.href, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
                'x-requested-with': 'XMLHttpRequest'
            },
            body: JSON.stringify({ action: 'like_post' })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                likeButton.textContent = `▲ ${data.likes} Like${data.likes !== 1 ? 's' : ''}`;
                likeButton.style.backgroundColor = data.liked ? 'darkgreen' : 'green';
            } else {
                alert('Error: ' + data.message);
            }
        });
    });

    // Report main thread post
    reportButton.addEventListener('click', function(event) {
        event.preventDefault();
        alert('Report functionality coming soon!');
    });

    // Like comment
    likeCommentButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            const postId = this.dataset.postId;

            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                    'x-requested-with': 'XMLHttpRequest'
                },
                body: JSON.stringify({ action: 'like_comment', post_id: postId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    button.textContent = `▲ ${data.likes} Like${data.likes !== 1 ? 's' : ''}`;
                    button.style.backgroundColor = data.liked ? 'darkgreen' : 'green';
                } else {
                    alert('Error: ' + data.message);
                }
            });
        });
    });

    // Report comment
    reportCommentButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            const postId = this.dataset.postId;

            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                    'x-requested-with': 'XMLHttpRequest'
                },
                body: JSON.stringify({ action: 'report_comment', post_id: postId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                } else {
                    alert('Error: ' + data.message);
                }
            });
        });
    });

     // Delete post logic with added console logs for troubleshooting
     deletePostButtons.forEach(button => {
        console.log("Attaching event listener to delete button");
        button.addEventListener('click', function(event) {
            event.preventDefault();
            console.log("Delete button clicked");

            const postId = this.dataset.postId;
            const threadId = this.dataset.threadId;

            console.log("Post ID:", postId);
            console.log("Thread ID:", threadId);

            if (!postId || !threadId) {
                console.error("Post or Thread ID is missing");
                alert('Post or Thread ID is missing');
                return;
            }

            fetch('/delete_post/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                    'x-requested-with': 'XMLHttpRequest'
                },
                body: JSON.stringify({ 'post_id': postId, 'thread_id': threadId })
            })
            .then(response => response.json())
            .then(data => {
                console.log("Response from server:", data);
                if (data.status === 'success') {
                    const postElement = document.getElementById(`post-${postId}`);
                    if (postElement) {
                        postElement.remove();
                        console.log("Post deleted from DOM");
                    } else {
                        console.error('Post element not found in DOM');
                    }
                } else {
                    console.error('Error:', data.message);
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => console.error('Error in fetch request:', error));
        });
    });
});
</script>
{% endblock %}
